name: Build Kernel for Nethunter
on:
  workflow_dispatch:
    inputs:
      variant:
        description: "Kernel variant to build"
        required: true
        default: "Lineage21"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set environment variables
        run: |
          echo "ARCH=arm64" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_COMPAT=arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV                                                                                                                          # Add toolchain paths to PATH
          echo "$GITHUB_WORKSPACE/toolchains/clang/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/toolchains/gas/bin" >> $GITHUB_PATH

      - name: Configure KernelSU
        if: ${{ github.event.inputs.variant == 'Lineage21' }}
        run: |
          echo "Applying KernelSU patches or configuration..."
          # Example steps to configure KernelSU
          git clone --depth=1 https://github.com/tiann/KernelSU.git KernelSU
          cd KernelSU
          ./patch.sh ../
          cd ..

      - name: Build kernel
        run: |
          echo "Building kernel for ${{ github.event.inputs.variant }}"
          # Clean previous builds
          make O=out clean
          make O=out mrproper
          # Configure defconfig (replace with your actual defconfig)
          make O=out ARCH=arm64 bluejay_defconfig # Replace bluejay_defconfig with your actual defconfig
          # Build the kernel
          make -j$(nproc) O=out \
            ARCH=arm64 \
            CC=clang \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
            CLANG_TRIPLE=aarch64-linux-gnu-

      - name: Upload kernel image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ github.event.inputs.variant }}
          path: out/arch/arm64/boot/Image
